generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Core Models
// ==========================================

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  name           String
  role           String   @default("owner") // owner, admin, member
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
}

model Organization {
  id                   String   @id @default(uuid())
  name                 String
  intent               String   // inbound, outbound
  subscription         Subscription?
  users                User[]
  agents               Agent[]
  phoneNumbers         PhoneNumber[]
  calls                Call[]
  campaigns            Campaign[]
  leads                Lead[]
  tools                Tool[]
  credentials          Credential[]
  usageRecords         UsageRecord[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Agent {
  id               String   @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name             String
  vapiAssistantId  String?
  direction        String   // inbound, outbound
  voiceProvider    String   @default("11labs")
  voiceId          String   @default("rachel")
  systemPrompt     String   @db.Text
  firstMessage     String   @default("Hello, how can I help you today?")
  language         String   @default("en")
  transferNumber   String?
  endCallPhrases   String[] @default([])
  isActive         Boolean  @default(true)
  phoneNumbers     PhoneNumber[]
  calls            Call[]
  campaigns        Campaign[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Extended Vapi configuration stored as JSON
  vapiConfig       Json?

  // Relations
  tools            Tool[]

  @@index([organizationId])
}

model Tool {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  description     String   @db.Text
  type            String   @default("api") // api, function, transfer

  // Parameter schema (JSON Schema format)
  parameters      Json?

  // For API Request tools
  apiEndpoint     String?
  apiMethod       String?  @default("POST")
  apiHeaders      Json?    // { "Authorization": "Bearer token", ... }
  apiBodyTemplate String?  @db.Text

  // For Transfer tools
  transferNumber  String?
  transferMessage String?

  // Vapi tool ID for reference
  vapiToolId      String?

  // Relations
  agents          Agent[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
}

model Credential {
  id                String   @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  provider          String   // twilio, vonage, telnyx, byo-sip-trunk
  vapiCredentialId  String?  @unique
  name              String?
  type              String?  // calcom, etc.
  config            Json?    // Provider-specific configuration
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([organizationId])
}

model PhoneNumber {
  id                String   @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  number            String
  type              String   @default("local") // local, toll_free, mobile, sip
  provider          String   @default("vapi") // vapi, twilio, vonage, telnyx, byo-phone-number
  vapiPhoneNumberId String?  @unique
  assignedAgentId   String?
  assignedAgent     Agent?   @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)
  friendlyName      String?
  country           String   @default("US")
  isActive          Boolean  @default(true)
  calls             Call[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([organizationId, number])
  @@index([organizationId])
}

model Call {
  id               String   @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentId          String?
  agent            Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
  phoneNumberId    String?
  phoneNumber      PhoneNumber? @relation(fields: [phoneNumberId], references: [id], onDelete: SetNull)
  campaignId       String?
  campaign         Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  leadId           String?  @unique
  lead             Lead?
  vapiCallId       String?  @unique
  direction        String   // inbound, outbound
  status           String   @default("queued") // queued, ringing, in_progress, completed, failed, no_answer, busy, canceled
  fromNumber       String
  toNumber         String
  startedAt        DateTime?
  endedAt          DateTime?
  durationSeconds  Int?
  transcript       String?  @db.Text
  recordingUrl     String?
  summary          String?  @db.Text
  outcome          String?
  costCents        Int?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@index([agentId])
  @@index([campaignId])
  @@index([vapiCallId])
  @@index([status])
}

model Campaign {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  status          String   @default("draft") // draft, active, paused, completed, archived
  totalLeads      Int      @default(0)
  calledLeads     Int      @default(0)
  successfulCalls Int      @default(0)
  failedCalls     Int      @default(0)
  leads           Lead[]
  calls           Call[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
}

model Lead {
  id             String   @id @default(uuid())
  campaignId     String
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  phone          String
  email          String?
  company        String?
  status         String   @default("pending") // pending, called, succeeded, failed, skipped
  callId         String?  @unique
  call           Call?    @relation(fields: [callId], references: [id], onDelete: SetNull)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([campaignId])
  @@index([organizationId])
  @@index([status])
}

// ==========================================
// Billing Models
// ==========================================

model Subscription {
  id                    String   @id @default(uuid())
  organizationId        String   @unique
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stripeCustomerId      String   @unique
  stripeSubscriptionId  String   @unique
  plan                  String   @default("free") // free, starter, professional
  status                String   @default("active") // active, trialing, past_due, canceled, unpaid
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  trialEndsAt           DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  invoices              Invoice[]
  usageRecords          UsageRecord[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Invoice {
  id                String   @id @default(uuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  stripeInvoiceId   String   @unique
  amount            Int      // in cents
  currency          String   @default("usd")
  status            String   @default("draft") // draft, open, paid, void, uncollectible
  pdfUrl            String?
  hostedInvoiceUrl  String?
  invoicePdf        String?
  periodStart       DateTime?
  periodEnd         DateTime?
  paidAt            DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([paidAt])
}

model UsageRecord {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptionId  String?
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  date            DateTime @default(now())
  callsCount      Int      @default(0)
  minutesUsed     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, date])
  @@index([organizationId])
  @@index([subscriptionId])
  @@index([date])
}
